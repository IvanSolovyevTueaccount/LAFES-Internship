# LAFES

This repository contains a Simulink-based control and simulation architecture together with supporting MATLAB code for operating the **Lead and Follow Education Setup**.

The purpose of this repo is to:
- Provide a modular Simulink architecture for running and analyzing the system
- Interface with the real hardware setup
- Implement a linear state-space model of the system
- Enable direct comparison between the linear model and the physical system

This framework is intended for educational and research use within the LAFES context.

The Linux installation and toolkit (`Dependencies/`) used to run this setup were taken and modified from the RoboCup DevPC installation, provided by Tech United Eindhoven.

## Quick Links

- [User Guide](#user-guide)
    - [Safety](#safety)
    - [Starting the Setup](#starting-the-setup)
    - [Running the Setup](#running-the-setup)
    - [Troubleshooting](#troubleshooting)
- [Simulink Architecture](#simulink-architecture)

## Repo Structure

| File or Folder  | Purpose |
|-|-|
| `LAFES.slx` | Main Simulink model. Integrates all components of the repository to operate, simulate, and communicate with the LAFES hardware setup. Handles signal routing and hardware interfacing |
| `model.m`| Generates the linear state-space / transfer function model of the LAFES system. This model is used within `LAFES.slx` to simulate the theoretical system response. |
| `Arduino/` | Arduino files to run the accelerometer of the system|
| `Leafsprings/` | Siemens NX (`.prt`) design files containing the CAD models of the leaf-spring components used in the mechanical system.|
| `Dependencies/` | C source files compiled within `LAFES.slx`. These handle low-level communication between Simulink and the system hardware.|
| `Support/` | Supporting MATLAB scripts for post-processing and analysis, such as Frequency Response Function (FRF) generation and leaf-spring stiffness calculations.|
| `Old/` | Archived files from previous development stages. Retained for traceability and reference.|

## Simulink Architecture
![simulink](/Images/simulink.png)

The LAFES control framework is implemented entirely in Simulink and runs in External Mode on an Ubuntu-based PC. Communication with the hardware is performed over EtherCAT using custom S-Functions derived from the Tech United RoboCup toolkit.

### Operating Principle
The architecture runs two parallel system paths:

1. Real System Path
    - Controller → Hardware Interface → Physical Plant → Sensors

2. Simulated System Path
    - Simulation Controller → Linear Transfer Function Model

Both paths receive identical reference inputs, allowing direct comparison between the real system and model responses.

### Layout
The Simulink model (`LAFES.slx`) is structured into clearly separated subsystems:

|Subsystem|Responsibilities|
|-|-|
|**Reference Generation**| <ul> <li>Generates reference position signals (step, sine, chirp, etc.)<li>Allows switching between generated reference and measured leader position <li>Outputs reference to controllers and logging blocks </ul>|
|**Controller**| <ul> <li>Implements feedforward and feedback control strategies <li>Computes target torque based on reference and measured position <li>Outputs torque command to hardware and simulated plant <li>Logs controller outputs</ul>|
|**Hardware Plant Interface**| <ul> <li>Communicates with hardware via EtherCAT <li>Sends control commands to EPOS4 motor driver <li>Reads sensor data (motor encoder, linear encoders) <li>Reads homing microswitches <li>Performs unit conversions and scaling <li>Implements zeroing logic and safety checks </ul>|
|**Simulated Plant**| <ul> <li>Implements linear transfer-function model generated by `model.m` <li>Receives identical inputs as hardware system <li>Simulates theoretical system response <li>Enables direct comparison with real system </ul>|
|**State Machine**| <ul> <li>Manages software operating states (Homing, Operational, Stopped, etc.) <li>Monitors safety signals and emergency conditions <li>Handles system enable/disable logic </ul>|
|**Dashboard (User Interface)** | <ul> <li>Provides manual control inputs (enable, zeroing, selectors) <li>Displays current system state <li>Allows switching between input modes and disturbance settings <li>Controls operating configuration during runtime </ul>|
|**Data Logging**| <ul> <li>Displays key signals via scopes (real vs simulated) <li>Saves runtime data to `.mat` files using `ToFile` blocks <li>Enables post-processing such as FRF analysis </ul>|

# User Guide
The User Guide provides step-by-step instructions for operating the LAFES setup. It covers powering the system, launching the Simulink model, configuring the dashboard, running experiments, and handling data logging and safety features.

## Dashboard
![dashboard](/Images/dashboard.png)

The Dashboard provides the main user interface for operating the LAFES setup. It allows you to:
- **Reset Homing** - After homing is done, reset the home positions and redo automatic homing.
- **Simulation Only** - If only running simulation, homing can be skipped using this button
- **Reset Simulation** - Reset state positions of simulation to 0
- **Motor Driver** – Controls whether the hardware motor driver is active if in operational state.
- **Reference** – Choose between generated reference signals or the measured leader position.
- **Sensed Mass** – Choose which mass position is used by the controller and for monitoring.
- **Disturbances** – Enable or disable disturbances (white noise) for testing or FRF measurements.

It displays the software state in the `State` display.

## Safetly
LAFES has a few hardware safety features. They work and/or can be used as:

1. The follower mass reached too close to the rail ends.
    - The software will call it `Out of Bounds`. Pushing the masses back in bounds **immediately** resumes operation.
2. The follower mass hits the outer end-stops making the hardware quick-stop the motor.
    - Turn off the Simulink and manually move the machine in bounds. 
    - Tweak the reference signal and/or controller so this does not happen again
    - Restart the system
3. The system is misbehaving in any way. Unwanted resonance, overdriven torque, misread positions, etc.
    - Hit the emergency stop button on the LAFES table. This **immediately** disables the motor driver and quick-stops the system.
    - Turn off the Simulink, reset the system, and carefully restart.

## Starting the setup
Before starting, make sure you understand the safety features and options of the setup. Then:
1. Turn on the PC.
2. Login using the provided credentials.
3. Once the PC is fully booted and showing its desktop, turn on power to the LAFES hardware.

### Launching the software
1. Open a terminal on the Ubuntu desktop (`Ctrl+Alt+T`).
2. Run the launching script with super-user privileges:
```
sudo ./launch_LAFES.sh
```
3. Wait for MatLab to open. The MatLab path will automatically be set to the correct folder
4. Wait for `LAFES.slx` to open in Simulink **automatically**.

## Running the setup
1. To start the setup, click the **Monitor and Tune** button in the **Hardware** section in the Simulink ribbon at the top of the screen.
2. The system automatically goes into a `Homing` state. Some steps are required to get the system homed and operational.
    - Manually move the Leader against the leftmost end-stop (the one with the switch)
    - Keep the leader there. The follower will start moving on its own. When it stops moving, the system has finished its homing and goes into its operational states.
3. The system will start running:
    - Real system path if enabled
    - Simulated path in parallel
    - Data logging begins automatically.
Check the dashboard to ensure zeroing and safety signals are correct before proceeding with experiments.

## Troubleshooting

show error if hardware disabled

show out of bounds state

emergency stop button pressed